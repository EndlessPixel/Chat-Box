<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ room.name }} - 聊天室</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // 页面加载时添加动画类
        window.addEventListener('DOMContentLoaded', function() {
            // 只在页面刷新时添加动画，而不是在页面跳转时
            let isRefresh = false;
            try {
                // 现代浏览器 API
                const navigationEntry = performance.getEntriesByType('navigation')[0];
                isRefresh = navigationEntry.type === 'reload' || navigationEntry.type === 'navigate';
            } catch (e) {
                // 旧浏览器 fallback
                isRefresh = performance.navigation.type === 0 || performance.navigation.type === 1;
            }
            
            if (isRefresh) {
                // 添加侧边栏动画
                document.querySelector('.sidebar').classList.add('animate');
                document.querySelector('.sidebar-header').classList.add('animate');
                document.querySelector('.sidebar-nav').classList.add('animate');
                document.querySelector('.chat-rooms').classList.add('animate');
                document.querySelector('.chat-rooms h2').classList.add('animate');
                
                // 添加导航项动画
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    item.classList.add('animate');
                });
                
                // 添加聊天室项动画
                const roomItems = document.querySelectorAll('.room-item');
                roomItems.forEach(item => {
                    item.classList.add('animate');
                });
                
                // 添加当前聊天室高亮动画
                const activeRoom = document.querySelector('.room-item a.active');
                if (activeRoom) {
                    activeRoom.classList.add('animate');
                }
            }
        });
    </script>
</head>
<body>
    {% include '_sidebar.html' %}
    
    <div class="main-content">
        <div class="main-header">
            <div class="room-info">
                <h2>{{ room.name }}</h2>
                <span class="user-role">
                    {% if member.role == 'owner' %}
                        聊天室主
                    {% elif member.role == 'admin' %}
                        管理员
                    {% else %}
                        普通成员
                    {% endif %}
                </span>
                {% if member.role == 'owner' %}
                    <a href="/edit_chat_room/{{ room.id }}" class="edit-link">编辑</a>
                {% endif %}
                {% if member.role in ['owner', 'admin'] %}
                    <button class="invite-btn" onclick="showInviteModal()">邀请用户</button>
                    <a href="/manage_forbidden_words/{{ room.id }}" class="forbidden-words-link">管理违禁词</a>
                {% endif %}
            </div>
            <a href="/chat" class="back-link">返回</a>
        </div>
        
        <!-- 邀请用户模态框 -->
        <div id="invite-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>邀请用户加入聊天室</h3>
                    <span class="close" onclick="hideInviteModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="invite-form" method="POST" action="/invite_user/{{ room.id }}">
                        <div class="form-group">
                            <label for="invite-user-id">用户ID或用户名</label>
                            <input type="text" id="invite-user-id" name="user_id" placeholder="输入用户ID或用户名" required>
                        </div>
                        <div class="form-group">
                            <label for="invite-role">角色</label>
                            <select id="invite-role" name="role">
                                <option value="member">普通成员</option>
                                <option value="admin">管理员</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="cancel-btn" onclick="hideInviteModal()">取消</button>
                            <input type="submit" value="发送邀请" class="submit-btn">
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="messages-area" id="messages-area">
                {% for message in messages %}
                    {% if message.is_撤回 %}
                        <div class="recall-message">
                            消息已撤回
                        </div>
                    {% else %}
                        <div class="message {% if message.sender_id == session['user_id'] %}own{% else %}other{% endif %}">
                            <div class="message-content">
                                <div class="message-header">
                                    {{ session['username'] if message.sender_id == session['user_id'] else message.sender_name }}
                                </div>
                                <div class="message-text">{{ message.content | replace('\n', '<br>') }}</div>
                                <div class="message-time">{{ message.formatted_time }}</div>
                                <!-- 消息操作菜单 -->
                                <div class="message-menu-container">
                                    <button class="menu-btn" onclick="toggleMessageMenu(this)">⋮</button>
                                    <div class="message-menu">
                                        {% if message.sender_id == session['user_id'] or member.role in ['owner', 'admin'] %}
                                            <div class="menu-item" onclick='recallMessage("{{ message.id }}")'>撤回消息</div>
                                        {% endif %}
                                        <div class="menu-item" data-message-id="{{ message.id }}" data-content="{{ message.content }}" data-sender="{{ message.sender_name }}" onclick="quoteMessage(this)">引用消息</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="message-input" 
                        placeholder="输入消息... (Shift+Enter换行，Enter发送)"
                        oninput="updateMessageSize()"
                    ></textarea>
                    <div class="input-footer">
                        <span class="message-size" id="message-size">0/5KB</span>
                        <button id="send-btn" onclick="debouncedSendMessage()">发送</button>
                    </div>
                </div>
                <div class="quick-phrases-panel">
                    <div class="quick-phrases-header">
                        <h4>快捷短语</h4>
                    </div>
                    <div class="quick-phrases-list" id="quick-phrases-list">
                        <!-- 快捷短语将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const roomId = "{{ room.id }}";
        const userId = "{{ session['user_id'] }}";
        const memberRole = "{{ member.role }}";
        let sendTimeout = null;
        let isSending = false;
        
        // 防抖函数
        function debounce(func, delay) {
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(sendTimeout);
                sendTimeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        
        // 更新消息大小
        function updateMessageSize() {
            const input = document.getElementById('message-input');
            const sizeSpan = document.getElementById('message-size');
            const size = new Blob([input.value]).size;
            const maxSize = 5 * 1024;
            sizeSpan.textContent = `${size}/${maxSize}B`;
            
            // 禁用发送按钮如果超过大小限制
            document.getElementById('send-btn').disabled = size > maxSize;
        }
        
        // 发送消息
        function sendMessage() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const content = input.value.trim();
            
            if (!content || isSending) return;
            
            isSending = true;
            sendBtn.disabled = true;
            sendBtn.textContent = '发送中...';
            
            if (isConnected) {
                // 使用WebSocket发送消息
                socket.emit('send_message', {
                    room_id: roomId,
                    user_id: userId,
                    content: content
                });
                
                input.value = '';
                updateMessageSize();
                showToast('消息发送成功', 'success');
                
                // 重置发送状态
                isSending = false;
                sendBtn.disabled = false;
                sendBtn.textContent = '发送';
            } else {
                // WebSocket未连接，使用HTTP请求作为后备
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/send_message', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.onreadystatechange = function() {
                    // 重置发送状态
                    isSending = false;
                    sendBtn.disabled = false;
                    sendBtn.textContent = '发送';
                    
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            input.value = '';
                            updateMessageSize();
                            showToast('消息发送成功', 'success');
                        } else {
                            showToast(response.message, 'error');
                        }
                    } else if (xhr.readyState === 4) {
                        showToast('消息发送失败，请重试', 'error');
                    }
                };
                xhr.send(`chat_room_id=${roomId}&content=${encodeURIComponent(content)}`);
            }
        }
        
        // 创建防抖版本的发送消息函数
        const debouncedSendMessage = debounce(sendMessage, 300);
        
        // 撤回消息
        function recallMessage(messageId) {
            showConfirm('确定要撤回这条消息吗？', () => {
                if (isConnected) {
                    // 使用WebSocket撤回消息
                    socket.emit('recall_message', {
                        message_id: messageId,
                        user_id: userId
                    });
                    
                    showToast('消息撤回成功', 'success');
                } else {
                    // WebSocket未连接，使用HTTP请求作为后备
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', `/recall_message/${messageId}`, true);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                showToast('消息撤回成功', 'success');
                            } else {
                                showToast(response.message, 'error');
                            }
                        }
                    };
                    xhr.send();
                }
            });
        }
        
        // 切换消息菜单显示
        function toggleMessageMenu(menuBtn) {
            // 关闭所有其他菜单
            const allMenus = document.querySelectorAll('.message-menu');
            allMenus.forEach(menu => {
                if (menu !== menuBtn.nextElementSibling) {
                    menu.style.display = 'none';
                }
            });
            
            // 切换当前菜单
            const menu = menuBtn.nextElementSibling;
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            
            // 点击外部关闭菜单
            document.addEventListener('click', function closeMenu(e) {
                if (!menuBtn.parentElement.contains(e.target)) {
                    menu.style.display = 'none';
                    document.removeEventListener('click', closeMenu);
                }
            });
        }
        
        // 引用消息
        function quoteMessage(menuItem) {
            const messageId = menuItem.getAttribute('data-message-id');
            const content = menuItem.getAttribute('data-content');
            const senderName = menuItem.getAttribute('data-sender');
            const input = document.getElementById('message-input');
            // 清除原有的引用
            const currentValue = input.value.replace(/^>.*?\n\n/, '');
            // 添加新的引用
            const quotedContent = `> ${senderName}: ${content.replace(/\n/g, '\n> ')}\n\n`;
            input.value = quotedContent + currentValue;
            input.focus();
            updateMessageSize();
        }
        
        // 键盘事件：Enter发送，Shift+Enter换行
        document.getElementById('message-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    // Shift+Enter换行，默认行为
                } else {
                    e.preventDefault();
                    debouncedSendMessage();
                }
            }
        });
        
        // WebSocket相关变量
        let socket = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 3000;
        let heartbeatInterval = null;
        let heartbeatTimeout = null;
        
        // 初始化
        window.onload = function() {
            updateMessageSize();
            // 滚动到底部
            const messagesArea = document.getElementById('messages-area');
            messagesArea.scrollTop = messagesArea.scrollHeight;
            
            // 初始化WebSocket连接
            initWebSocket();
            
            // 加载快捷短语
            loadQuickPhrases();
        };
        
        // 加载快捷短语
        function loadQuickPhrases() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/get_quick_phrases', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        displayQuickPhrases(response.phrases);
                    }
                }
            };
            xhr.send();
        }
        
        // 显示快捷短语
        function displayQuickPhrases(phrases) {
            const quickPhrasesList = document.getElementById('quick-phrases-list');
            quickPhrasesList.innerHTML = '';
            
            if (phrases.length === 0) {
                quickPhrasesList.innerHTML = '<div class="no-phrases">暂无快捷短语</div>';
                return;
            }
            
            phrases.forEach(phrase => {
                const phraseElement = document.createElement('div');
                phraseElement.className = 'quick-phrase-item';
                phraseElement.textContent = phrase.content;
                phraseElement.onclick = function() {
                    insertQuickPhrase(phrase.content);
                };
                quickPhrasesList.appendChild(phraseElement);
            });
        }
        
        // 插入快捷短语到输入框
        function insertQuickPhrase(phrase) {
            const input = document.getElementById('message-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const currentValue = input.value;
            
            // 插入快捷短语
            const newValue = currentValue.substring(0, start) + phrase + currentValue.substring(end);
            input.value = newValue;
            
            // 更新消息大小
            updateMessageSize();
            
            // 重新聚焦输入框并设置光标位置
            input.focus();
            const newPosition = start + phrase.length;
            input.selectionStart = newPosition;
            input.selectionEnd = newPosition;
        }
        
        // 初始化WebSocket连接
        function initWebSocket() {
            try {
                // 创建WebSocket连接
                socket = io();
                
                // 连接成功事件
                socket.on('connect', () => {
                    console.log('WebSocket连接成功');
                    isConnected = true;
                    reconnectAttempts = 0;
                    
                    // 加入当前聊天室
                    socket.emit('join_room', {
                        room_id: roomId,
                        user_id: userId
                    });
                    
                    // 启动心跳机制
                    startHeartbeat();
                });
                
                // 连接失败事件
                socket.on('connect_error', (error) => {
                    console.error('WebSocket连接失败:', error);
                    isConnected = false;
                });
                
                // 断开连接事件
                socket.on('disconnect', (reason) => {
                    console.log('WebSocket断开连接:', reason);
                    isConnected = false;
                    stopHeartbeat();
                    
                    // 尝试重连
                    attemptReconnect();
                });
                
                // 心跳响应
                socket.on('pong', () => {
                    clearTimeout(heartbeatTimeout);
                });
                
                // 新消息事件
                socket.on('new_message', (message) => {
                    displayNewMessages([message]);
                });
                
                // 消息撤回事件
                socket.on('message_recalled', (data) => {
                    // 更新消息状态
                    const messageElement = document.querySelector(`[data-message-id="${data.message_id}"]`);
                    if (messageElement) {
                        messageElement.innerHTML = '<div class="recall-message">消息已撤回</div>';
                    }
                });
                
                // 垃圾消息警告事件
                socket.on('spam_warning', (data) => {
                    showToast(data.message, 'error');
                    // 重置发送状态
                    isSending = false;
                    const sendBtn = document.getElementById('send-btn');
                    sendBtn.disabled = false;
                    sendBtn.textContent = '发送';
                });
                
                // 错误事件
                socket.on('error', (error) => {
                    console.error('WebSocket错误:', error);
                });
                
            } catch (error) {
                console.error('WebSocket初始化失败:', error);
                isConnected = false;
                attemptReconnect();
            }
        }
        
        // 尝试重连
        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`尝试重连 ${reconnectAttempts}/${maxReconnectAttempts}...`);
                
                setTimeout(() => {
                    initWebSocket();
                }, reconnectDelay);
            } else {
                console.error('WebSocket重连失败，已达到最大尝试次数');
            }
        }
        
        // 启动心跳机制
        function startHeartbeat() {
            // 每30秒发送一次心跳
            heartbeatInterval = setInterval(() => {
                if (isConnected) {
                    socket.emit('ping');
                    
                    // 设置心跳超时，10秒内没收到pong则断开连接
                    heartbeatTimeout = setTimeout(() => {
                        console.error('WebSocket心跳超时');
                        socket.disconnect();
                    }, 10000);
                }
            }, 30000);
        }
        
        // 停止心跳机制
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            if (heartbeatTimeout) {
                clearTimeout(heartbeatTimeout);
                heartbeatTimeout = null;
            }
        }
        
        // 显示新消息
        function displayNewMessages(messages) {
            const messagesArea = document.getElementById('messages-area');
            let shouldScroll = false;
            
            // 检查是否已经在底部
            const isAtBottom = messagesArea.scrollTop + messagesArea.clientHeight >= messagesArea.scrollHeight - 50;
            
            messages.forEach(message => {
                if (message.is_撤回) {
                    // 显示撤回消息
                    const recallDiv = document.createElement('div');
                    recallDiv.className = 'recall-message';
                    recallDiv.textContent = '消息已撤回';
                    messagesArea.appendChild(recallDiv);
                } else {
                    // 显示普通消息
                    const messageDiv = document.createElement('div');
                    // 客户端根据自己的userId判断消息是否是自己发送的
                    const isOwn = message.sender_id == userId;
                    messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
                    messageDiv.setAttribute('data-message-id', message.id);
                    
                    const messageContent = document.createElement('div');
                    messageContent.className = 'message-content';
                    
                    const messageHeader = document.createElement('div');
                    messageHeader.className = 'message-header';
                    messageHeader.textContent = message.sender_name;
                    
                    const messageText = document.createElement('div');
                    messageText.className = 'message-text';
                    messageText.innerHTML = message.content.replace(/\n/g, '<br>');
                    
                    const messageTime = document.createElement('div');
                    messageTime.className = 'message-time';
                    messageTime.textContent = message.formatted_time;
                    
                    // 消息操作菜单
                    const menuContainer = document.createElement('div');
                    menuContainer.className = 'message-menu-container';
                    
                    const menuBtn = document.createElement('button');
                    menuBtn.className = 'menu-btn';
                    menuBtn.textContent = '⋮';
                    menuBtn.onclick = function() { toggleMessageMenu(this); };
                    
                    const messageMenu = document.createElement('div');
                    messageMenu.className = 'message-menu';
                    
                    // 撤回消息菜单项
                    if (message.sender_id == userId || memberRole == 'owner' || memberRole == 'admin') {
                        const recallItem = document.createElement('div');
                        recallItem.className = 'menu-item';
                        recallItem.textContent = '撤回消息';
                        recallItem.onclick = function() { recallMessage(message.id); };
                        messageMenu.appendChild(recallItem);
                    }
                    
                    // 引用消息菜单项
                    const quoteItem = document.createElement('div');
                    quoteItem.className = 'menu-item';
                    quoteItem.textContent = '引用消息';
                    quoteItem.setAttribute('data-message-id', message.id);
                    quoteItem.setAttribute('data-content', message.content);
                    quoteItem.setAttribute('data-sender', message.sender_name);
                    quoteItem.onclick = function() { quoteMessage(this); };
                    messageMenu.appendChild(quoteItem);
                    
                    menuContainer.appendChild(menuBtn);
                    menuContainer.appendChild(messageMenu);
                    
                    messageContent.appendChild(messageHeader);
                    messageContent.appendChild(messageText);
                    messageContent.appendChild(messageTime);
                    messageContent.appendChild(menuContainer);
                    messageDiv.appendChild(messageContent);
                    messagesArea.appendChild(messageDiv);
                }
            });
            
            // 如果已经在底部，滚动到底部
            if (isAtBottom) {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
        }
        
        // 显示邀请模态框
        function showInviteModal() {
            document.getElementById('invite-modal').style.display = 'block';
        }
        
        // 隐藏邀请模态框
        function hideInviteModal() {
            document.getElementById('invite-modal').style.display = 'none';
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('invite-modal');
            if (event.target == modal) {
                hideInviteModal();
            }
        };
        
        // 自定义提示组件函数
        function showToast(message, type = 'info', duration = 3000) {
            // 创建toast元素（如果不存在）
            let toast = document.getElementById('custom-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'custom-toast';
                document.body.appendChild(toast);
            }
            
            // 设置内容和类型
            toast.textContent = message;
            toast.className = type;
            
            // 显示toast
            toast.classList.add('show');
            
            // 自动隐藏
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }
        
        // 自定义确认框函数
        function showConfirm(message, okCallback, cancelCallback) {
            // 创建确认框元素（如果不存在）
            let confirmBox = document.getElementById('custom-confirm');
            if (!confirmBox) {
                confirmBox = document.createElement('div');
                confirmBox.id = 'custom-confirm';
                confirmBox.innerHTML = `
                    <div class="confirm-header">确认操作</div>
                    <div class="confirm-body"></div>
                    <div class="confirm-footer">
                        <button class="confirm-btn confirm-cancel">取消</button>
                        <button class="confirm-btn confirm-ok">确认</button>
                    </div>
                `;
                document.body.appendChild(confirmBox);
            }
            
            // 设置内容
            confirmBox.querySelector('.confirm-body').textContent = message;
            
            // 显示确认框
            confirmBox.classList.add('show');
            
            // 绑定事件
            const okBtn = confirmBox.querySelector('.confirm-ok');
            const cancelBtn = confirmBox.querySelector('.confirm-cancel');
            
            // 移除之前的事件监听器
            okBtn.replaceWith(okBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
            
            // 重新获取元素并绑定事件
            const newOkBtn = confirmBox.querySelector('.confirm-ok');
            const newCancelBtn = confirmBox.querySelector('.confirm-cancel');
            
            newOkBtn.addEventListener('click', () => {
                confirmBox.classList.remove('show');
                if (okCallback) okCallback();
            });
            
            newCancelBtn.addEventListener('click', () => {
                confirmBox.classList.remove('show');
                if (cancelCallback) cancelCallback();
            });
            
            // 点击外部关闭
            window.onclick = function(event) {
                if (event.target == confirmBox) {
                    confirmBox.classList.remove('show');
                    if (cancelCallback) cancelCallback();
                }
            };
        }
    </script>
</body>
</html>